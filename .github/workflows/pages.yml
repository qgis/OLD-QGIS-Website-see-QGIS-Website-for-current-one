name: Deploy static content to Pages

on: [push]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
#concurrency:
#  group: "pages"
#  cancel-in-progress: true
env:
  FEED_FOLDER: output/html/feeds

jobs:
  # Single deploy job since we're just deploying
  build:
    strategy:
      matrix:
        language:
          - en
          - ca
          - da
          - de
          - es
          - fa
          - fi
          - fr
          - gl
          - hu
          - id
          - it
          - ja
          - km_KH
          - ko
          - lt
          - nl
          - pl
          - pt_BR
          - pt_PT
          - ro
          - tr
          - ru
          - uk
          - zh-Hans
          - zh-Hant

    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
            pip install -r REQUIREMENTS.txt

      - name: Build sphinx website
        run: |
          rm -rf i18n
          curl -L https://github.com/qgis/QGIS-Website-i18n/archive/refs/heads/main.tar.gz | tar -xz QGIS-Website-i18n-main/i18n --strip-components=1
          make -e LANG="${{ matrix.language }}" html
      
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.WEBSERVER_SSH_KEY }}
          known_hosts: 'just-a-placeholder-so-we-dont-get-errors'
      
      - name: Adding Known Hosts
        run: ssh-keyscan -H ${{ secrets.WEBSERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: Deploy with rsync
        run: rsync -avz output/html ${{ secrets.WEBSERVER_IP }}:${{ secrets.WEBSERVER_ROOT_FOLDER }}/${{ matrix.language }}


  update-feeds:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Update feeds
        run: |
          echo $(pwd)
          ls -ls
          mkdir -p ${{ env.FEED_FOLDER }}
          curl "https://api.flickr.com/services/feeds/groups_pool.gne?id=2244553@N22&lang=en-us&format=atom" -o ${{ env.FEED_FOLDER }}/qgisflickrmaps.atom
          curl "https://api.flickr.com/services/feeds/groups_pool.gne?id=2327386@N22&lang=en-us&format=atom" -o ${{ env.FEED_FOLDER }}/qgisflickrscreenshots.atom
          curl "https://plugins.qgis.org/planet/feed/atom/" -o ${{ env.FEED_FOLDER }}/qgisplanet.atom
          cp source/feeds/qugsnews.atom ${{ env.FEED_FOLDER }}/qugsnews.atom
          curl -k -A Mozilla https://changelog.qgis.org/en/qgis/members/json/ -o ${{ env.FEED_FOLDER }}/members.json
          curl -k -A Mozilla https://changelog.qgis.org/en/qgis/past-members/json/?years_limit=2 -o ${{ env.FEED_FOLDER }}/qgispastmembers.json
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.WEBSERVER_SSH_KEY }}
          known_hosts: 'just-a-placeholder-so-we-dont-get-errors'
      
      - name: Adding Known Hosts
        run: ssh-keyscan -H ${{ secrets.WEBSERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: Deploy with rsync
        run: rsync -avz output/html/feeds ${{ secrets.WEBSERVER_IP }}:${{ secrets.WEBSERVER_ROOT_FOLDER }}/feeds
      
