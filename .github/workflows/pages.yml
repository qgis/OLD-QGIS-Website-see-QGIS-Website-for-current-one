name: Deploy static content to Pages

on: [push]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow one concurrent deployment
#concurrency:
#  group: "pages"
#  cancel-in-progress: true

jobs:
  # Single deploy job since we're just deploying
  build:
    strategy:
      matrix:
        language:
          - en
          - ca
          - da
          - de
          - es
          - fa
          - fi
          - fr
          - gl
          - hu
          - id
          - it
          - ja
          - km_KH
          - ko
          - lt
          - nl
          - pl
          - pt_BR
          - pt_PT
          - ro
          - tr
          - ru
          - uk
          - zh-Hans
          - zh-Hant

    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Pages
        uses: actions/configure-pages@v1

      - name: Install dependencies
        run: |
            pip install -r REQUIREMENTS.txt

      - name: Build sphinx website
        run: |
          rm -rf i18n
          curl -L https://github.com/qgis/QGIS-Website-i18n/archive/refs/heads/main.tar.gz | tar -xz QGIS-Website-i18n-main/i18n --strip-components=1
          make -e LANG="${{ matrix.language }}" html

      - name: Update feeds
        run: |
          mkdir -p output/html/feeds
          cd output/html/feeds
          curl "https://api.flickr.com/services/feeds/groups_pool.gne?id=2244553@N22&lang=en-us&format=atom" -o qgisflickrmaps.atom
          curl "https://api.flickr.com/services/feeds/groups_pool.gne?id=2327386@N22&lang=en-us&format=atom" -o qgisflickrscreenshots.atom
          curl -o qgisplanet.atom "https://plugins.qgis.org/planet/feed/atom/"
          cp ${{ github.workspace }}/source/feeds/qugsnews.atom qugsnews.atom
          curl -k -A Mozilla https://changelog.qgis.org/en/qgis/members/json/ -o members.json
          curl -k -A Mozilla https://changelog.qgis.org/en/qgis/past-members/json/?years_limit=2 -o qgispastmembers.json

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          path: 'output/html'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          path: 'output/html'
      
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.WEBSERVER_SSH_KEY }}
          known_hosts: 'just-a-placeholder-so-we-dont-get-errors'
      
      - name: Adding Known Hosts
        run: ssh-keyscan -H ${{ secrets.WEBSERVER_IP }} >> ~/.ssh/known_hosts
      
      - name: Deploy with rsync
        run: rsync -avz output/html ${{ secrets.WEBSERVER_IP }}:${{WEBSERVER_ROOT_FOLDER}}
